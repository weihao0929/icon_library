name: Update Ayden_icon.json Structure

on:
  push:
    paths:
      - 'icon/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate and update JSON script
        id: generator
        shell: python
        run: |
          import os
          import json

          # --- 配置区域 ---
          icon_folder = 'icon'
          json_file_path = 'Documents/Ayden_icon.json'
          base_url = 'https://raw.githubusercontent.com/weihao0929/icon_library/main/icon/'
          
          # 定义 JSON 的基础结构
          json_data = {
            "name": "Ayden_icon",
            "icons": [],
            "description": " Ayden_icon 是 Ayden 呕心沥血收集的图标集 "
          }

          new_icons_list = []

          # 1. 扫描 icon 文件夹
          if os.path.exists(icon_folder):
              files = sorted(os.listdir(icon_folder))
              for filename in files:
                  if filename.startswith('.'):
                      continue
                      
                  if filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.svg')):
                      icon_entry = {
                          "name": filename,
                          "url": base_url + filename
                      }
                      new_icons_list.append(icon_entry)
          else:
              print(f"Warning: Folder '{icon_folder}' not found.")

          # 2. 更新数据
          json_data["icons"] = new_icons_list

          # 3. 写入文件
          os.makedirs(os.path.dirname(json_file_path), exist_ok=True)

          with open(json_file_path, 'w', encoding='utf-8') as f:
              json.dump(json_data, f, ensure_ascii=False, indent=4)
          
          print(f"JSON structure updated successfully.")

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Documents/Ayden_icon.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Ayden_icon.json structure" && git push)
